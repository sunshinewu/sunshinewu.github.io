<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>「FunFace」用一张粉嫩的小脸，来谈谈HTML5 Canvas的某些玩意儿 | SunshineWu.Print() | 老鲜肉和他的技术“渣”谈</title>
  <meta name="author" content="Sunshine.Wu">
  
  <meta name="description" content="这年头，HTML5火遍大江南北呀，神马？火遍全球？对！（在国内跟着火的，还有一个叫“H5”的名儿，具体你懂的）
跟着它顺便火的，还有个HTML5的新标签，叫Canvas，专门用于Web界面画画图，搞点交互，模拟，游戏啥的。虽然大家都称Canvas为HTML5的新标签，看起来好像跟HTML语言有什么关联似的，但其实Canvas画图是通过JavaScript来实现的。所以，如果你想学习Canvas画图，你最好要有一定的JavaScript基础。">
  
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="「FunFace」用一张粉嫩的小脸，来谈谈HTML5 Canvas的某些玩意儿"/>
  <meta property="og:site_name" content="SunshineWu.Print()"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="SunshineWu.Print()" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d92dc1ab429496757fa0b326d16dcec0";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>


<body>
<div id="page" class="site">
  <div id="primary" class="content-area">

    <header id="header" class="inner"><div class="site-branding container cyan brackets">
  <h1 class="site-title">
    <a href="/">SunshineWu.Print()</a>
  </h1>
  <p class="site-description">老鲜肉和他的技术“渣”谈</p>
</div>
<nav id="site-navigation" class="main-navigation containerNav bracketsNav" role="navigation">
  <ul>
    
      <li><a href="/">主页</a></li>
    
      <li><a href="/archives">归档</a></li>
    
      <li><a href="/atom.xml">订阅</a></li>
    
      <li><a href="/about">关于</a></li>
    
      <li><a href="/links">邻居</a></li>
    
  </ul>
</nav></header>

    <article id="content" class="site-content">
      <main id="main" class="site-main posts-loop" role="main">
        <article class="post article">

  
  
    <h3 class="article-title"><span>「FunFace」用一张粉嫩的小脸，来谈谈HTML5 Canvas的某些玩意儿</span></h3>
  


  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/07/29/FunFace/" rel="bookmark">
        <time class="entry-date published" datetime="2016-07-28T17:01:17.000Z">
          2016-07-29
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <p>这年头，HTML5火遍大江南北呀，神马？火遍全球？对！（在国内跟着火的，还有一个叫“H5”的名儿，具体你懂的）</p>
<p>跟着它顺便火的，还有个HTML5的新标签，叫<strong>Canvas</strong>，专门用于Web界面画画图，搞点交互，模拟，游戏啥的。虽然大家都称Canvas为HTML5的新标签，看起来好像跟HTML语言有什么关联似的，但其实Canvas画图是通过JavaScript来实现的。所以，如果你想学习Canvas画图，你最好要有一定的JavaScript基础。</p>
<center><br><img src="http://sunshinewu.github.io/images/FunFace.gif"><br><br></center><a id="more"></a><br><br><br><br>#  前言<br><br>提到画图，现实下对于没啥美术天赋及基础滴人来说，那简直不易，就是再怎么画，明明你心目中想画的是白龙马，结果画完画风一变成了草泥马-_-| 而程序里头，这画图涉及到图形学，也不易啊，若还想在静态图形的基础上配个动画，啧啧，必须用上各种小学中学乃至大学各种数学物理知识，那个时候，瞬间发现，原来学了介么多年的数理化，总算有用武之地了，那个内牛满面。<br><br>“说了这么多不相干的啰嗦，你说，那今天我们到底要整啥？！” ——路人甲<br><br>“来，别急嘛，我们先上一张可爱的效果图”<br><br><br><br>##  「FunFace」一张粉嫩的欢乐脸<br><br><br><center><br><img src="http://sunshinewu.github.io/images/RecordFunFace.gif"><br></center>



<p>我嘞个去，有点意思嘛！</p>
<h1 id="How-to-do-it-肿么实现"><a href="#How-to-do-it-肿么实现" class="headerlink" title="How to do it 肿么实现?"></a>How to do it 肿么实现?</h1><p>想看整个实现的所有源文件？请访问<a href="https://github.com/sunshinewu/FunFace" target="_blank" rel="external">全球最大“同性”交友平台GitHub FunFace</a>了解，想切身体验一下？请不必客气地点击此<a href="https://sunshinewu.github.io/FunFace/">Demo</a></p>
<p>光这样就行？那我一些关键点还是看不懂啊啊啊~好吧，俺把源码重点部分该注释的都重新注释助于理解之外，并抽取其中的一些核心代码来谈谈HTML5 Canvas的一些东东。</p>
<h2 id="核心一"><a href="#核心一" class="headerlink" title="核心一"></a>核心一</h2><p>先定义一个init函数进行一个<strong>初始化</strong>的工作，将画布的宽高、鼠标的位置坐标、瞳孔的归位控制、眼睛的位置及半径等等变量做初始化。这里会涉及到一个重要的核心点——<strong>requestAnimationFrame</strong></p>
<p>起初，我们要完成一些动画效果的话，会经常使用window.setTimout()或者window.setInterval()来定时不断更新元素的DOM状态位置等来实现动画（画面的更新频率必须要达到每秒60次才能让肉眼看到流畅的动画效果）。不过，这样实现动画的方式极为耗费资源，经常出现这样的情况，刚开始比较流畅，几分钟之后动画可能就不行了。</p>
<p>如今，HTML5/CSS3时代，我们要想在Web里实现一些动画，可选择性已经丰富了很多。借助requestAnimationFrame，CSS3的transition，CSS3的animattion+keyframes等等都能实现想要的一些动画。但是，CSS3动画还是有不少局限性，比如不是所有属性都能参与动画、动画缓动效果太少、无法完全控制动画过程等等，所以有的时候我们还是不得不使用setTimeout或setInterval的方式来实现动画，可setTimeout和setInterval有着严重的性能问题，虽然某些现代浏览器对这两函数进行了一些优化，但还是无法跟CSS3的动画性能相提并论。这个时候，就该requestAnimationFrame上场了，这次这个案例主要就是通过requestAnimationFrame来实现。</p>
<h3 id="关于requestAnimationFrame"><a href="#关于requestAnimationFrame" class="headerlink" title="关于requestAnimationFrame"></a>关于requestAnimationFrame</h3><p>来看下<a href="https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame" target="_blank" rel="external">Mozilla MDN</a>给出的诠释：</p>
<blockquote>
<p>The window.requestAnimationFrame() method tells the browser that you wish to perform an animation and requests that the browser call a specified function to update an animation before the next repaint. The method takes as an argument a callback to be invoked before the repaint.</p>
</blockquote>
<p>也就说，window.requestAnimationFrame()这个方法是用来在页面重绘之前，通知浏览器调用一个指定的函数，以满足开发者操作动画的需求。这个方法接受一个函数为参，该函数会在重绘前进行调用。</p>
<p>这个方法的原理，其实大致跟setTimeout/setInterval差不多，通过递归调用同一方法来不断更新画面以达到动起来的效果，但比setTimeout/setInterval更具优势：</p>
<ul>
<li>浏览器自动专门优化，且重绘的时间间隔紧紧跟随浏览器的刷新频率，动画更流畅；</li>
<li>若页面不是激活状态（隐藏或不可见）下，动画会自动暂停，有效节省CPU、GPU及内存开销；</li>
</ul>
<h4 id="使用语法："><a href="#使用语法：" class="headerlink" title="使用语法："></a>使用语法：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">window.requestAnimationFrame(callback);</div></pre></td></tr></table></figure>
<h4 id="浏览器最新支持情况"><a href="#浏览器最新支持情况" class="headerlink" title="浏览器最新支持情况"></a>浏览器最新支持情况</h4><p>就目前来说，主流现代浏览器都对它提供了较好的支持，包括IE10+，Firefox，Chrome，Safari，Opera等，在移动设备上，除了Opera Mini之外也都支持requestAnimationFrame，如下图所示：</p>
<center><br><img src="http://sunshinewu.github.io/images/requestAnimationFrameSupport.gif"><br></center>


<h4 id="浏览器Polyfill兼容延伸"><a href="#浏览器Polyfill兼容延伸" class="headerlink" title="浏览器Polyfill兼容延伸"></a>浏览器Polyfill兼容延伸</h4><p>支持requestAnimationFrame的浏览器有些还是自己的私有实现，所以有些还得加前缀，对于不支持requestAnimationFrame的浏览器，我们只能使用setTimeout，因为两者的使用方式几近相同，所以这两者的兼容并不难。对于支持requestAnimationFrame的浏览器，我们使用requestAnimationFrame，而不支持的我们优雅降级使用传统的setTimeout。以下为封装后统一能兼容各大浏览器的API。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">var lastTime = 0;</div><div class="line">var prefixes = &apos;webkit moz ms o&apos;.split(&apos; &apos;); //各浏览器前缀</div><div class="line"></div><div class="line">var requestAnimationFrame = window.requestAnimationFrame;</div><div class="line">var cancelAnimationFrame = window.cancelAnimationFrame;</div><div class="line"></div><div class="line">var prefix;</div><div class="line">//通过遍历各浏览器前缀，来得到requestAnimationFrame和cancelAnimationFrame在当前浏览器的实现形式</div><div class="line">for( var i = 0; i &lt; prefixes.length; i++ ) &#123;</div><div class="line">    if ( requestAnimationFrame &amp;&amp; cancelAnimationFrame ) &#123;</div><div class="line">      break;</div><div class="line">    &#125;</div><div class="line">    prefix = prefixes[i];</div><div class="line">    requestAnimationFrame = requestAnimationFrame || window[ prefix + &apos;RequestAnimationFrame&apos; ];</div><div class="line">    cancelAnimationFrame  = cancelAnimationFrame  || window[ prefix + &apos;CancelAnimationFrame&apos; ] || window[ prefix + &apos;CancelRequestAnimationFrame&apos; ];</div><div class="line">&#125;</div><div class="line"></div><div class="line">//如果当前浏览器不支持requestAnimationFrame和cancelAnimationFrame，则会退到setTimeout</div><div class="line">if ( !requestAnimationFrame || !cancelAnimationFrame ) &#123;</div><div class="line">    requestAnimationFrame = function( callback, element ) &#123;</div><div class="line">      var currTime = new Date().getTime();</div><div class="line">      //为了使setTimteout的尽可能的接近每秒60帧的效果</div><div class="line">      var timeToCall = Math.max( 0, 16 - ( currTime - lastTime ) ); </div><div class="line">      var id = window.setTimeout( function() &#123;</div><div class="line">        callback( currTime + timeToCall );</div><div class="line">      &#125;, timeToCall );</div><div class="line">      lastTime = currTime + timeToCall;</div><div class="line">      return id;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    cancelAnimationFrame = function( id ) &#123;</div><div class="line">      window.clearTimeout( id );</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//得到兼容各浏览器的API</div><div class="line">window.requestAnimationFrame = requestAnimationFrame; </div><div class="line">window.cancelAnimationFrame = cancelAnimationFrame;</div></pre></td></tr></table></figure>
<h2 id="核心二"><a href="#核心二" class="headerlink" title="核心二"></a>核心二</h2><p>我们画画以及实现动画的基础，是确定好每一个画中的元素的坐标，半径，移动方式，移动速度等等，只有确定好了这些数据，才能进行下一步的绘画过程，这就好比炒一个菜，你得先准备好食材，才能进行下一步的加工烹饪。</p>
<p>我们这个案例最重要的就是确定跟随鼠标位置移动的瞳孔如何绘制，这就涉及到瞳孔的中心点（pupilX, pupilY）的实时位置，涉及到如何计算两点之间距离，为了有动画效果还要计算出加速度及偏移量的弹动等等。</p>
<p>比如这次案例里当鼠标移动时所要计算的“鼠标所在点位置”与“眼睛中心点”两点的距离。一般来说，如果是计算任意两点的距离，有两种方法：一种利用<strong>勾股定理</strong>计算，适用于两点距离很近的情况；一种按标准的球面大圆劣弧长度计算，适用于距离较远的情况。我们这次主要采用前者进行计算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">var dx = mx - this.x, </div><div class="line">    dy = my - this.y,</div><div class="line">    dist = Math.sqrt(dx * dx + dy * dy);  //计算“鼠标所在点位置”与“眼睛中心点”两点的距离</div></pre></td></tr></table></figure>
<p>通过以上计算，就可以算出两点的距离。除了距离，我们还得计算出偏移的角度来，可通过下面计算得出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">this.angle = Math.atan2(dy, dx);  //偏移角度</div></pre></td></tr></table></figure>
<p><strong>偏移角度</strong>拿来做什么呢？主要是用来进行下一步计算得到<strong>加速度</strong>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Math.cos(this.angle) * this.magnitude  //magnitude为移动距离，大概的范围是：0 =&lt; 移动距离 &lt;= magnitudeMax</div></pre></td></tr></table></figure>
<p>最终我们计算出加速度下的<strong>偏移量弹动值 + 瞳孔原坐标值 = 最新瞳孔的中心坐标</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">this.pupilX += ((this.x + Math.cos(this.angle) * this.magnitude) - this.pupilX) * 0.1;  </div><div class="line">//X轴瞳孔中心偏移量的弹动  0.1为弹性系数</div><div class="line">this.pupilY += ((this.y + Math.sin(this.angle) * this.magnitude) - this.pupilY) * 0.1; </div><div class="line"> //Y轴瞳孔中心偏移量的弹动</div></pre></td></tr></table></figure>
<h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>待所有的数据都确定准备好了，就可以完成最终的简单绘画过程了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Eye.prototype.draw = function () &#123;</div><div class="line">    //画眼睛及眼眶</div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(this.x, this.y, this.radius, 0, 2 * PI);</div><div class="line">    ctx.fillStyle = &apos;#FFFFFF&apos;;</div><div class="line">    ctx.fill();</div><div class="line">    ctx.lineWidth = 5;</div><div class="line">    ctx.strokeStyle = &apos;#424031&apos;;</div><div class="line">    ctx.stroke();</div><div class="line">    //画瞳孔</div><div class="line">    ctx.beginPath();</div><div class="line">    ctx.arc(this.pupilX, this.pupilY, this.pupilRadius, 0, 2 * PI);</div><div class="line">    ctx.fillStyle = &apos;#424031&apos;;</div><div class="line">    ctx.fill();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//画嘴巴</div><div class="line">ctx.beginPath();</div><div class="line">ctx.arc(width / 2, height * 0.65, 100, 0, PI);</div><div class="line">ctx.fillStyle = &apos;#424031&apos;;</div><div class="line">ctx.fill();</div></pre></td></tr></table></figure>
<p>此刻，一个粉嫩的欢乐小脸，出现在了你的面前 :)</p>

      
    </div>
    <footer class="article-footer">
        <div class="article-meta pull-left">
          
  

  <span class="post-categories">
    <i class="icon-categories"></i>
    <a href="/categories/HTML5/">HTML5</a>
  </span>


          
  

  <span class="post-tags">
    <i class="icon-tags"></i>
    <a href="/tags/JavaScript/">JavaScript</a>, <a href="/tags/HTML5/">HTML5</a>, <a href="/tags/Canvas/">Canvas</a>, <a href="/tags/动画/">动画</a>, <a href="/tags/animation/">animation</a>
  </span>


        </div>
        
    </footer>
  </div>
</article>

  
	<div id="comment">
	
	
	<!-- 多说评论框 start -->
	 <div class="ds-thread" data-thread-key="/2016/07/29/FunFace/" data-title="「FunFace」用一张粉嫩的小脸，来谈谈HTML5 Canvas的某些玩意儿" data-url="http://sunshinewu.github.io/2016/07/29/FunFace/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"sunshinewu"};
	  (function() {
	    var ds = document.createElement('script');
	    ds.type = 'text/javascript';ds.async = true;
	    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	    ds.charset = 'UTF-8';
	    (document.getElementsByTagName('head')[0] 
	     || document.getElementsByTagName('body')[0]).appendChild(ds);
	  })();
	  </script>
	<!-- 多说公共JS代码 end -->
	
	</div>




      </main>
    </article>

    <footer id="colophon" class="site-footer" role="contentinfo"><p class="site-info">
  Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
  Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
  </br>
  
  &copy; 2016 Sunshine.Wu
  
</p>
</footer>
    
  </div>
</div>
</body>
</html>